#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <openssl/bn.h>
#include <openssl/crypto.h>
#include <openssl/opensslv.h>

//#define DEBUG

#ifdef MINLIBC
#include "minlibc.h"
#endif

struct bignum_st {
  BN_ULONG *d;                /* Pointer to an array of 'BN_BITS2' bit
                               * chunks. */
  int top;                    /* Index of last used d +1. */
  /* The next are internal book keeping for bn_expand. */
  int dmax;                   /* Size of the d array. */
  int neg;                    /* one if the number is negative */
  int flags;
};

int main(int argc, char* argv[]) {
#ifdef DEBUG
  printf("OpenSSL version: %s\n", OpenSSL_version(OPENSSL_VERSION));
#endif

  static const unsigned char p_min_one[] = \
  "\xbe\x75\xfa\x7d\x87\x2a\xb7\x10\x05\x28"; // 80 bit

  static const unsigned char e_inp[] = \
    "\x03"; // pair A (works)

  static const unsigned char page_separation_inp[] = \
  "\x9c\x7c\xd6\x48\x68\x14\x5d\xcd\x87\x2a\xa3\xf2\xa8\xcf\xef\xaf\x26\x85\xd4\x53\x30\x7e\x7e\xeb\x0c\x9c\x4b\x57\x8b\xcf\x55\xfe\x16\x83\xe7\xed\x4e\x9b\xaa\x74\x7b\x64\x11\x4f\xa2\x47\x73\x0f\xd4\xba\xf0\x27\x4c\x06\x4b\x41\x24\xf5\xcd\x0b\xea\x2e\x98\xbc\xfe\xba\x32\x89\xae\xb9\xb8\x32\xf8\xb0\x22\x94\x5a\xee\x69\x45\x76\xed\xa5\x2f\x45\x75\xc2\xcb\xcf\x42\xb1\x3b\x24\xde\x19\x1c\xf3\x96\xf3\x74\x26\x16\xc7\xa0\x21\x73\xc6\x4f\x42\xe6\x20\x9d\x78\x86\x68\x4f\x24\xa7\xc3\x84\xd1\x1a\xcf\x6e\xd2\x56\xed\x54\xbf\x8b\x7e\x0b\x75\x00\xa3\xaa\xbf\xed\x91\x9d\x66\x8b\x40\x53\x4d\x64\x50\xd6\xad\x79\xcf\x97\xf8\x1a\x99\x83\xf9\x62\x06\x97\x84\x0d\xa9\xe5\xf4\xe1\xca\xf1\x9c\xdc\xdc\xc8\xd8\x97\x52\xf3\xdd\xc9\x46\xed\xaf\xfd\xf0\xe4\x77\x3a\x0a\x53\xbf\xb3\xc9\xff\x1b\x92\xbe\x87\xd7\x9c\x9a\x8b\x75\x5e\x92\xa5\xb9\x4a\xda\x2f\xc4\x15\x25\x2a\x98\x17\x29\x6f\xee\x42\xce\xb9\x7f\xc6\x83\x0a\xc4\xbb\x83\xfc\xb2\x30\x75\x39\x28\xc0\xaf\xec\x74\x7e\x33\x03\xbe\x18\xe6\xf3\xb6\x4d\x58\x7c\x87\x05\xaf\x7b\xe4\xc3\xe8\x6e\xaa\x82\xa2\x44\xf6\x9c\x8d\x0d\x47\x11\xf5\xf5\x99\xe6\x6c\xdb\x6a\x51\x3a\x00\x97\xf9\x30\x61\xa5\xb8\x2c\x5b\x84\x74\x62\xbb\x03\xfe\xfb\x55\x81\x06\xe0\x5c\xab\x4d\xc0\xf4\x86\x1a\x5b\xcb\xc6\x64\x6c\x4f\x3a\x09\x51\x33\x6e\x6c\x18\x15\xa1\x2a\x0d\x46\x6a\xa6\x18\xac\x8a\xbe\x16\xcc\x37\x80\x0a\x89\xe2\xea\xd4\x30\xdd\xbe\x97\x3e\x37\xa8\x6c\xc8\x20\x3a\xa1\xb4\xeb\xa2\xad\xa1\xf9\x88\x2b\xea\xd2\x92\xa8\x9a\xc1\x7c\x5c\x48\x44\x32\x74\x50\xb1\xaa\xef\x0c\x9f\x84\xe1\x08\xed\xfd\x36\x44\xbe\xde\x7e\x49\x2a\xb7\x1b\x81\xfb\xb8\x3f\xfd\x90\x9f\x1e\xd7\x46\xc0\xd3\xa3\xdf\x18\xe5\x38\xa0\xe0\xd2\xfa\x94\xbc\xab\x2e\x89\xd8\xf0\x0e\xd6\xb9\xb2\x41\x01\xdb\x7a\x1c\x73\xf0\x21\x8d\x79\x95\xc6\x4f\xa6\x40\xc0\x9b\xeb\x33\x76\xd2\xf0\x71\x54\x62\x90\xd9\x40\x65\x47\x5c\xea\x52\xda\xf3\x00\xe3\xd9\xf8\xf7\xc2\xb6\xaf\x45\x8f\xd6\xd2\x45\xaa\x17\x63\xc4\xe3\x41\xda\x53\x82\x23\xad\x62\x1c\x73\x76\xb1\x76\xfa\xbe\xf4\xee\x61\xfa\xd8\xa2\x16\xe9\x4d\xc5\x9a\xa4\x10\xe6\xd7\xb8\xe4\xfc\xb8\x1d\xff\xed\xf7\xa4\xba\x71";

  BN_CTX* ctx = BN_CTX_new();

  BIGNUM* p_minus_one = BN_new();
  BN_bin2bn(p_min_one, sizeof(p_min_one) - 1, p_minus_one);

  BIGNUM* page_separation = BN_new();
  BN_bin2bn(page_separation_inp, sizeof(page_separation_inp) - 1, page_separation);

  BIGNUM* e = BN_new();
  BN_bin2bn(e_inp, sizeof(e_inp) - 1, e);

  BIGNUM* r = BN_new();
#ifdef DEBUG
  printf("P->d = %p\n", p_minus_one->d);
  printf("E->d = %p\n", e->d);
  int difference = e->d - p_minus_one->d;
  difference = difference > 0 ? difference : -difference;  // abs
  if (difference > 0) {
    printf("[+] P and E are on different pages :)\n");
  } else {
    printf("[-] P and E are on the same page :(\n");
  }
#endif

  int ret = BN_gcd(r, p_minus_one, e, ctx);
#ifdef DEBUG
  if (ret != 1) {
    printf("Error in BN_gcd\n");
    return -1;
  }
#endif


#ifdef DEBUG
  char *p_minus_one_str = BN_bn2dec(p_minus_one);
  char *e_str = BN_bn2dec(e);
  char *r_str = BN_bn2dec(r);
  printf("p-1 = %s\n", p_minus_one_str);
  printf("e = %s\n", e_str);
  printf("r = %s\n", r_str);
#endif

  exit(EXIT_SUCCESS);
}
